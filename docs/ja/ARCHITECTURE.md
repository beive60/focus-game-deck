# Focus Game Deck - Architecture & Design Philosophy

## 概要

Focus Game Deck は、ゲーミング環境の自動化とOBS配信管理を行うPowerShellベースのツールです。このドキュメントでは、プロジェクトの設計思想、技術選択の理由、および実装アーキテクチャについて説明します。

## 設計思想

### 1. 軽量性とシンプルさ

- **PowerShell + WPF**: 追加のランタイムや重いフレームワークを避け、Windows標準機能を活用
- **最小限の依存関係**: .NET Framework標準機能のみを使用
- **単一実行ファイル**: ps2exeによる実行ファイル化で配布を簡素化

### 2. 保守性と拡張性

- **設定駆動型アーキテクチャ**: 動作はすべて`config.json`で制御し、コード変更不要でカスタマイズ可能
- **モジュラー構造**: GUI、コア機能、設定管理を分離
- **国際化対応**: JSON外部リソースによる多言語サポート

### 3. ユーザビリティ

- **直感的なGUI**: 3タブ構造による機能分類（ゲーム設定、管理アプリ設定、グローバル設定）
- **バッチファイル起動**: 技術知識を必要としない簡単起動
- **エラーハンドリング**: 適切な日本語エラーメッセージ表示

## 技術アーキテクチャ

### システム構成

```
Focus Game Deck
├── Core Engine (PowerShell)
│   ├── src/Invoke-FocusGameDeck.ps1     # メインエンジン
│   ├── src/Invoke-FocusGameDeck-MultiPlatform.ps1  # マルチプラットフォーム版
│   ├── scripts/Create-Launchers.ps1     # ランチャー生成
│   └── launch_*.bat                     # ゲーム別起動スクリプト
│
├── Configuration Management
│   ├── config/config.json               # メイン設定ファイル
│   ├── config/config.json.sample        # サンプル設定
│   ├── config/messages.json             # 国際化リソース（GUI用）
│   └── config/signing-config.json       # デジタル署名設定
│
├── GUI Module (PowerShell + WPF)
│   ├── gui/MainWindow.xaml              # UIレイアウト定義
│   ├── gui/ConfigEditor.ps1             # GUI制御ロジック
│   ├── gui/messages.json                # GUI用メッセージリソース
│   └── gui/Build-ConfigEditor.ps1       # GUIビルドスクリプト
│
├── Build System & Distribution
│   ├── build-tools/                     # ビルド専用ツール
│   │   ├── Build-FocusGameDeck.ps1      # メインビルドスクリプト
│   │   └── Sign-Executables.ps1         # デジタル署名スクリプト
│   ├── Sign-Executables.ps1             # デジタル署名スクリプト
│   ├── Master-Build.ps1                 # 統合ビルド統制
│   ├── build/                           # ビルド成果物ディレクトリ
│   ├── signed/                          # 署名済み実行ファイルディレクトリ
│   └── release/                         # リリースパッケージディレクトリ
│
└── Documentation & Testing
    ├── docs/                            # 設計・仕様書
    ├── test/                            # テストスクリプト
    └── DOCUMENTATION-INDEX.md           # ドキュメント索引
```

### 設計判断の記録

#### 1. GUI技術選択: PowerShell + WPF

**検討した選択肢:**

- Windows Forms
- Electron/Web技術
- .NET WinForms/WPF (C#)
- PowerShell + WPF ✅

**選択理由:**

- **軽量性**: 追加ランタイム不要、Windows標準機能
- **統一性**: メインエンジンと同じPowerShellで実装
- **配布容易性**: ps2exeによる単一実行ファイル化
- **開発効率**: 既存PowerShellスキルを活用

#### 2. 国際化手法: JSON外部リソース

**検討した選択肢:**

- Unicodeコードポイント直接指定
- PowerShell内埋め込み文字列
- JSON外部リソースファイル ✅

**選択理由:**

- **文字化け解決**: PowerShell MessageBox の日本語文字化け問題を回避
- **保守性**: 文字列とコードの分離
- **拡張性**: 将来的な多言語対応への対応
- **標準的手法**: 一般的な国際化パターン

**技術的詳細:**

- Unicodeエスケープシーケンス（`\u30XX`形式）使用
- UTF-8エンコーディング強制設定
- 実行時JSON読み込みによる動的メッセージ取得

#### 3. ビルドシステム: PowerShell から実行ファイルへの変換

**検討した選択肢:**

- PowerShellスクリプトの手動配布
- PowerShell ISE パッケージング
- ps2exe モジュール コンパイル ✅
- コンパイル言語（C#/.NET）への移行

**選択理由:**

- **単一ファイル配布**: ps2exe による独立実行ファイル作成で配布を簡素化
- **ランタイム依存解消**: PowerShell インストール不要で実行可能
- **デジタル署名対応**: Authenticode デジタル署名の完全サポート
- **PowerShell利点維持**: ソースコードの可読性と保守性を保持
- **セキュリティ準拠**: 拡張検証証明書署名による信頼確立

**技術的実装:**

- **メインアプリケーション**: `Focus-Game-Deck.exe`（コンソールベースランチャー）
- **マルチプラットフォーム版**: `Focus-Game-Deck-MultiPlatform.exe`（拡張プラットフォーム対応）
- **GUI設定エディタ**: `Focus-Game-Deck-Config-Editor.exe`（WPFベース、コンソールウィンドウなし）
- **自動化ビルドパイプライン**: 3階層ビルドシステム（個別→統合→マスター統制）

#### 4. デジタル署名戦略: 拡張検証証明書

**セキュリティ要件:**

- **信頼確立**: Windows SmartScreen とアンチウイルスソフト互換性
- **アンチチート準拠**: 署名済み実行ファイルによる事前ホワイトリスト登録
- **タイムスタンプ保存**: 長期署名有効性のための RFC 3161 タイムスタンプ

**実装詳細:**

- Windows 証明書ストア（CurrentUser\My）での証明書管理
- 署名後の自動署名検証
- 複数タイムスタンプサーバーのフォールバック対応
- リリースパッケージでの署名メタデータ追跡

#### 5. 設定管理: JSON設定ファイル

**選択理由:**

- **可読性**: 人間が読みやすい形式
- **PowerShell互換性**: ConvertFrom-Json/ConvertTo-Json標準対応
- **階層構造**: 複雑な設定を構造化して管理
- **バージョン管理**: Gitでの差分確認が容易

## 実装ガイドライン

### コーディング規約

1. **エンコーディング**: すべてのファイルはUTF-8で保存
2. **エラーハンドリング**: Try-Catch-Finallyパターンを徹底
3. **関数命名**: PowerShell動詞-名詞パターン（Verb-Noun）
4. **コメント**: 日本語コメント許可（UTF-8保証）

### GUI開発ガイドライン

1. **XAML構造**:
   - x:Class属性は使用しない（PowerShell互換性のため）
   - Name属性による要素参照
   - TabControl による機能分類

2. **メッセージ表示**:

   ```powershell
   # 推奨: JSON外部リソース使用
   Show-SafeMessage -MessageKey "configSaved" -TitleKey "info"

   # 非推奨: 直接文字列指定
   [System.Windows.MessageBox]::Show("設定が保存されました")
   ```

3. **設定管理**:

   ```powershell
   # 設定読み込み
   $config = Get-Content $configPath -Raw -Encoding UTF8 | ConvertFrom-Json

   # 設定保存
   $config | ConvertTo-Json -Depth 10 | Set-Content $configPath -Encoding UTF8
   ```

## パフォーマンス考慮事項

### 起動時間最適化

- JSON読み込みの遅延実行
- WPFアセンブリの事前読み込み
- XAML解析の最適化

### メモリ使用量

- PowerShell ISE vs 通常PowerShell の差異を考慮
- 大きなオブジェクトの適切な解放
- イベントハンドラーのメモリリーク対策

## セキュリティ考慮事項とリスク管理

### 最重要リスク：アンチチートシステムによる誤検知対策

**技術的アプローチ（非侵入的設計の徹底）**:

- ゲームプロセスのメモリ読み取り・書き込み、コードインジェクションといった侵入的な操作は一切行わない
- プロセスの操作は、OSに標準で備わる公式な機能（Get-Process, Stop-Process等）のみを利用
- 透明性の確保: 全ソースコードをGitHubで公開し、コードの安全性を誰でも監査できる状態を維持

**プロアクティブな対話**:

- 主要なアンチチート開発元（Epic Games, BattlEye等）に対し、本プロジェクトの目的と技術的仕様を事前に通知し、ホワイトリストへの登録依頼を行う

### 実行ポリシーと配布戦略

- **開発時**: `-ExecutionPolicy Bypass` による制限回避
- **配布時**: **コードサイニング証明書によるデジタル署名を必須**とし、信頼された認証局（CA）による署名済み実行ファイル（.exe）のみを公式配布
- 署名済みファイルにより、Windows SmartScreenやセキュリティソフトからの信頼を確保

### 設定ファイル保護とプライバシー

- **機密情報の暗号化**: OBS WebSocketパスワード等は、Windowsのデータ保護機能（DPAPI）を利用し、SecureStringを介してユーザーアカウントに紐づく形で暗号化保存
- **設定ファイルのアクセス権限制御**: 適切なファイルパーミッション設定

## 今後の拡張予定

### 最優先（アルファテスト期）

- [ ] アルファテスト計画の実施（5～10名のテスター募集）
- [ ] デジタル署名による公式配布体制の確立
- [ ] セキュリティ監査とアンチチート開発者への事前通知

### 短期（v1.1）

- [ ] 英語メッセージリソースの追加
- [ ] 設定バリデーション強化
- [ ] エラーログ機能

### 中期（v1.2）

- [ ] プラグインアーキテクチャ
- [ ] テーマ機能
- [ ] 設定インポート/エクスポート

### 長期（v2.0）

- [ ] クラウド設定同期
- [ ] Web UI オプション
- [ ] マルチプラットフォーム対応

## 貢献ガイドライン

この設計思想を維持するために、以下の点を重視してください：

1. **セキュリティファースト**: アンチチート誤検知リスクを常に考慮した非侵入的設計
2. **軽量性の維持**: 新しい依存関係の追加は慎重に検討
3. **PowerShell First**: 他の言語への移行よりもPowerShellでの解決を優先
4. **設定駆動**: ハードコードではなく設定ファイルでの制御
5. **国際化対応**: 新しいメッセージは必ずJSON外部リソース化

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|----------|
| 1.0.0 | 2025-09-23 | 初期アーキテクチャ設計、GUI実装完了 |
| 1.0.1 | 2025-09-23 | JSON外部リソース国際化対応完了 |
| 1.1.0 | 2025-09-23 | リスク管理方針とセキュリティ設計の統合 |
| 1.2.0 | 2025-09-24 | ビルドシステム実装、デジタル署名インフラ完了 |

---

*このドキュメントは、Focus Game Deck プロジェクトの設計思想と技術選択を記録し、将来の開発者が一貫した方針で開発を継続できるようにすることを目的としています。*
