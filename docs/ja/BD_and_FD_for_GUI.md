# **Focus Game Deck GUI設定エディタ 設計書**

| ドキュメントID | FGD-GUI-001 |
| :---- | :---- |
| **作成日** | 2025年9月23日 |
| **作成者** | Gemini |
| **バージョン** | 1.0 |

---

## **第1部 基本設計書 (BD / System Specification)**

### **1\. 概要**

本ドキュメントは、PowerShellスクリプト「Focus Game Deck」の設定ファイル (`config.json`) を、GUI（Graphical User Interface）を通じて直感的に編集するためのアプリケーション（以下、本アプリ）の基本設計を定義するものである。

### **2\. 開発の背景と目的**

`Focus Game Deck` の設定は、現在JSON形式のテキストファイルの手動編集に依存している。この方式は柔軟性が高い一方で、以下の課題を抱えている。

* **構文エラーのリスク:** JSONの知識がないユーザーが編集すると、カンマの抜けや括弧の不整合などでスクリプト全体が動作しなくなる可能性がある。
* **導入のハードル:** テキスト編集に不慣れなユーザーにとって、設定作業が心理的な障壁となっている。

本アプリはこれらの課題を解決し、「PCに詳しくないゲーマーにも直感的に使える」 \[/doc/CONTRIBUTING.md\] というプロジェクトの指導原則を実現することを目的とする。`ROADMAP.md`においても、本機能は最重要課題として位置づけられている。

### **3\. システム構成**

* **実行環境:** Windows 10 / 11
* **使用技術:**
  * **言語/フレームワーク:** PowerShell \+ WPF (Windows Presentation Foundation)
  * **理由:** プロジェクト本体との技術的親和性が高く、`CONTRIBUTING.md`の思想に沿った軽量なネイティブアプリケーションを構築できるため \[cite: beive60/focus-game-deck/focus-game-deck-07d61cd785d2b8a3803169874e213731807c0a07/CONTRIBUTING.md\]。

**ファイル構成:**
focus-game-deck/
└─ gui/
   ├─ ConfigEditor.ps1   (本アプリのメインロジック)
   └─ MainWindow.xaml    (本アプリのUI定義)

* **配布形式:** `PS2EXE`等のツールを使用し、単一の実行可能ファイル (`.exe`) として配布する。

### **4\. 機能要件**

| ID | 機能名 | 概要 |
| :---- | :---- | :---- |
| FR-01 | **設定ファイルの読み込み** | 起動時に`../config/config.json`を読み込み、内容を画面に表示する。存在しない場合は`../config/config.json.sample`を読み込む。 |
| FR-02 | **ゲーム設定管理** | 管理対象ゲームの追加、編集、削除ができる。 |
| FR-03 | **管理アプリ設定管理** | 制御対象アプリケーションの追加、編集、削除ができる。 |
| FR-04 | **グローバル設定管理** | OBS連携、主要パス、表示言語などの全体設定を編集できる。 |
| FR-05 | **設定ファイルの保存** | 画面上で行ったすべての変更を、構文的に正しいJSONとして`../config/config.json`に保存する。 |
| FR-08 | **バリデーション** | 入力値の妥当性をチェックし、エラーがあれば保存を防止し、ユーザーにフィードバックを提供する。 |

### **5\. 非機能要件**

| ID | 種別 | 内容 |
| :---- | :---- | :---- |
| NFR-01 | **パフォーマンス** | アプリケーションは軽量かつ高速に起動し、リソース消費を最小限に抑えること。 |
| NFR-02 | **ユーザビリティ** | 直感的なUIを提供し、ファイル選択ダイアログやドロップダウンリストを活用することで、ユーザーの入力ミスを防止すること。 |
| NFR-03 | **拡張性** | 将来的な設定項目（他プラットフォーム対応、プロファイル機能など）の追加を容易にするため、UIとロジックを分離した設計とすること。 |
| NFR-04 | **多言語対応** | UIに表示される文字列は、将来的に外部ファイルから読み込める設計を考慮すること。 |
| NFR-05 | **レスポンシブデザイン** | ウィンドウサイズの変更に応じて、UIレイアウトが適切に調整される。 |

---

## **第2部 機能設計書 (FD / Functional Design)**

### **1\. 画面設計**

本アプリは単一のウィンドウで構成され、主要機能を3つのタブで切り替える。

* **ウィンドウタイトル:** `Focus Game Deck - 設定エディタ`
* **UI構成:**
  * **タブコントロール:**
    * `ゲーム設定` タブ
    * `管理アプリ設定` タブ
    * `グローバル設定` タブ
  * **フッター:**
    * `保存` ボタン
    * `閉じる` ボタン

**(詳細はワイヤーフレームを参照)**

### **2\. 機能詳細**

#### **2.1. 共通処理**

* **起動処理:**
  1. `ConfigEditor.ps1`が実行される。
  2. WPFアセンブリをロードする。
  3. `MainWindow.xaml`を読み込み、UIオブジェクトを生成する。
  4. `FR-01`に基づき設定ファイルを読み込み、UIコントロールに値を設定（データバインディング）する。
  5. 各UIコントロールのイベントハンドラを登録する。
  6. ウィンドウを表示する。

#### **2.2. 「ゲーム設定」タブ**

* **画面構成:** 左側にゲームリストボックス、右側に選択したゲームの詳細設定パネルを配置。
* **データフロー:**
  * 起動時、`config.json`の`games`オブジェクトのキーを左のリストボックスに表示する。
  * ユーザーがリストボックスの項目を選択すると、`SelectionChanged`イベントが発火。
  * 選択されたゲームIDに対応する設定値（name, steamAppId等）を`config.json`データから取得し、右パネルの各コントロールに表示する。
  * `appsToManage`のチェックボックスリストは、「管理アプリ設定」タブで登録されている全アプリ名を元に動的に生成される。
* **イベント:**
  * `新規追加`ボタン: リストに「新しいゲーム」を追加し、右パネルを空にする。
  * `削除`ボタン: リストで選択中のゲームを削除する。

#### **2.3. 「管理アプリ設定」タブ**

* **画面構成:** 左側にアプリリストボックス、右側に選択したアプリの詳細設定パネルを配置。
* **データフロー:**
  * 起動時、`config.json`の`managedApps`オブジェクトのキーを左のリストボックスに表示する。
  * リストボックス選択時、対応するアプリの詳細を右パネルに表示する。
  * `gameStartAction`/`gameEndAction`は、固定値（"start-process", "stop-process", "toggle-hotkeys", "none"）を持つドロップダウンリストとする \[cite: beive60/focus-game-deck/focus-game-deck-07d61cd785d2b8a3803169874e213731807c0a07/config/config.json.sample\]。
* **イベント:**
  * `参照`ボタン: 実行ファイル選択ダイアログを開き、選択されたパスを`実行ファイルパス`テキストボックスに設定する。

#### **2.4. 「グローバル設定」タブ**

* **画面構成:** `OBS連携設定`, `パス設定`, `全体設定`の3つのグループで構成。
* **データフロー:**
  1. 起動時、`config.json`の`obs`, `paths`, `language`の各値を対応するコントロールに表示する。
  2. `パスワード`テキストボックスは、入力値をマスキング表示する。

#### **2.5. フッター**

* **`保存`ボタン:**
  1. `Click`イベントが発火。
  2. 全タブのUIコントロールから現在の値を取得する。
  3. `config.json`と同じ階層構造を持つPowerShellオブジェクトを新規に作成し、取得した値を格納する。
  4. 作成したオブジェクトを`ConvertTo-Json`でJSON文字列に変換する。
  5. `FR-05`に基づき、`../config/config.json`にファイルとして上書き保存する。
  6. 「保存しました」という確認メッセージを表示する。
* **`閉じる`ボタン:**
  1. `Click`イベントが発火。
  2. ウィンドウを閉じる。変更が保存されていない場合の警告はv1.0では実装しない（将来的な改善項目）。

### **2.6. セキュリティとリスク管理要件**

GUI設定エディタに固有のセキュリティ要件を以下に定める：

* **設定ファイルセキュリティ**:
  * パスワード暗号化: OBS WebSocketパスワード等の機密情報は、Windows DPAPI（SecureString）による暗号化保存
  * 設定バリデーション: 不正な値や危険なパス指定を検知し、事前に防止
  * ファイルパス検証: 実行ファイルパスやディレクトリパスの妥当性確認

* **入力検証**:
  * ファイルパス存在確認: 指定されたファイルパスが実際に存在するかの確認
  * 数値範囲チェック: ポート番号等の数値項目の妥当な範囲確認
  * JSON構造の整合性確認: 設定ファイルの構造が正しいことの確認
  * 必須項目チェック: 必要な設定項目が入力されているかの確認

* **アプリケーションセキュリティ**:
  * デジタル署名: 公式配布版は必ずコードサイニング証明書による署名を実施
  * 透明性の確保: オープンソースとしてコードの安全性を担保

### **2.7. アルファテスト対応機能**

アルファテスト実施時の要件に対応するため、以下の機能を実装予定：

* **フィードバック収集支援**: エラー情報や設定状況を簡単にエクスポートできる機能
* **テスター向け支援**: 設定例の自動生成やプリセット機能による導入支援
* **バージョン管理**: 設定ファイルのバージョニングとマイグレーション機能

### **3\. データ構造（`config.json`とのマッピング）**

本アプリが編集対象とする`config.json`のデータ構造は`config.json.sample`に準拠する。各UIコントロールは、このJSONファイルの各キーと1対1で対応する。(詳細は`.\config\config.json.sample`を参照)。

## 画面設計（ワイヤーフレーム）

ユーザーが直感的に操作できるよう、主要な設定項目をタブで分離したシンプルなデザインを提案します。

### メインウィンドウ

アプリケーションの全体的な構造です。3つの主要なタブで設定項目を明確に分け、下部に操作ボタンを配置します。

```txt
+-----------------------------------------------------------------+
| Focus Game Deck - 設定エディタ                                  |
+-----------------------------------------------------------------+
| | ゲーム設定 | | 管理アプリ設定 | | グローバル設定 |            |
+-----------------------------------------------------------------+
|                                                                 |
|                                                                 |
|         （ここに選択したタブの内容が表示される）                  |
|                                                                 |
|                                                                 |
|                                                                 |
|                                                                 |
|                                                                 |
+-----------------------------------------------------------------+
|                                               [ 保存 ] [ 閉じる ] |
+-----------------------------------------------------------------+
```

* タブ1: ゲーム設定
  * ユーザーが管理したいゲームを追加・編集・削除する画面です。左のリストでゲームを選び、右のパネルで詳細を設定します。

appsToManage の項目は、「管理アプリ設定」タブで登録されたアプリ名が自動的にチェックボックスリストとして表示されます。

```txt
+-----------------------------------------------------------------+
| ゲームリスト              | 選択したゲームの詳細                |
| +-----------------------+ | ----------------------------------- |
| | Apex Legends          | | GameID:     [apex____________]      |
| | Dead by Daylight      | | 表示名:     [Apex Legends____]      |
| |                       | | Steam AppID:[1172470_________]      |
| +-----------------------+ | プロセス名: [r5apex*_________]      |
| [ 新規追加... ] [ 削除 ]  |                                     |
|                           | 管理するアプリ:                     |
|                           | [x] noWinKey                        |
|                           | [x] autoHotkey                      |
|                           | [x] luna                            |
|                           | [x] obs                             |
|                           | [x] clibor                          |
+-----------------------------------------------------------------+
```

* タブ2: 管理アプリ設定
  * ゲームの起動・終了時に制御したいアプリケーションを登録する画面です。基本的な構造は「ゲーム設定」タブと似ています。

Action項目はドロップダウンリストから選択させることで、設定ミスを防ぎます。

```txt
+-----------------------------------------------------------------+
| アプリリスト              | 選択したアプリの詳細                |
| +-----------------------+ | ----------------------------------- |
| | noWinKey              | | アプリID:       [noWinKey________]    |
| | autoHotkey            | | 実行ファイルパス: [C:\Apps\NWK..] [参照] |
| | clibor                | | プロセス名:     [NoWinKey________]    |
| | luna                  | |                                     |
| +-----------------------+ | ゲーム開始時の動作:                   |
| [ 新規追加... ] [ 削除 ]  |   [start-process          ^]          |
|                           | ゲーム終了時の動作:                   |
|                           |   [stop-process           ^]          |
|                           | 起動引数:       [________________]    |
+-----------------------------------------------------------------+
```

* タブ3: グローバル設定
  * 特定のゲームやアプリに依存しない、全体的な設定項目を管理する画面です。

パスワード入力欄は*でマスキング表示します。

言語はmessages.jsonに存在する言語キーを元にドロップダウンを自動生成します。

```txt
+-----------------------------------------------------------------+
| OBS連携設定                                                     |
|   ホスト:     [localhost_______]  ポート: [4455__]                |
|   パスワード: [****************]                                |
|   [x] ゲーム中にリプレイバッファを有効にする                    |
| --------------------------------------------------------------- |
| パス設定                                                        |
|   Steam.exeのパス:  [C:\Program Files..] [参照]                 |
|   obs64.exeのパス:  [C:\Program Files..] [参照]                 |
| --------------------------------------------------------------- |
| 全体設定                                                        |
|   表示言語: [日本語 (ja)            ^]                          |
|                                                                 |
+-----------------------------------------------------------------+
```

---

## **補足: 実装設計思想**

### **技術選択の記録**

本GUI設定エディタの実装において、以下の設計判断を行った。これらの判断は将来の保守性と拡張性を考慮したものである。

#### **1. GUI技術: PowerShell + WPF**

**選択理由:**
- **統一性**: メインエンジンと同じPowerShell環境で実装
- **軽量性**: 追加ランタイム不要、Windows標準機能を活用
- **配布容易性**: ps2exeによる単一実行ファイル化が可能

#### **2. 国際化手法: JSON外部リソース**

**技術的背景:**
PowerShell の `[System.Windows.MessageBox]` における日本語文字化け問題に対し、以下の手法を検証：

1. **Unicodeコードポイント直接指定** ✅
2. **JSON外部リソースファイル** (採用)
3. **PowerShell内埋め込み文字列** ❌

**採用判断:**
- **保守性**: 文字列とコードの分離により、翻訳やメッセージ変更が容易
- **標準的手法**: 一般的な国際化パターンに従った実装
- **拡張性**: 将来的な多言語対応への布石

**技術詳細:**
```json
{
    "messages": {
        "configSaved": "\u8a2d\u5b9a\u304c\u4fdd\u5b58\u3055\u308c\u307e\u3057\u305f\u3002"
    }
}
```

#### **3. アーキテクチャパターン**

**ファイル構成:**
```
gui/
├── MainWindow.xaml          # UIレイアウト (x:Class属性なし)
├── ConfigEditor.ps1         # メインロジック
├── messages.json           # 国際化リソース
└── Build-ConfigEditor.ps1  # ビルドスクリプト
```

**設計パターン:**
- **MVVMライク**: XAMLとPowerShellの分離
- **イベント駆動**: ボタンクリック等のUI操作をハンドラーで処理
- **設定駆動**: すべての動作を config.json で制御

#### **4. エラーハンドリング戦略**

**メッセージ表示パターン:**
```powershell
# 推奨パターン: JSON外部リソース使用
Show-SafeMessage -MessageKey "configSaved" -TitleKey "info"

# 従来パターン: 直接指定（非推奨）
[System.Windows.MessageBox]::Show("設定が保存されました")
```

### **パフォーマンス最適化**

1. **起動時間短縮**: JSON読み込みの遅延実行
2. **メモリ効率**: PowerShell ISE vs 標準PowerShell の差異を考慮
3. **UI応答性**: 重い処理の非同期実行検討

### **将来の拡張予定**

- **テーマ機能**: UI色設定のカスタマイズ
- **プラグイン対応**: 外部スクリプトとの連携
- **クラウド同期**: 設定の外部保存・共有機能

---

*本設計思想は、Focus Game Deck プロジェクトの技術的継続性を保証し、新しい開発者が一貫した方針で開発を継続できることを目的として記録されている。*
