name: CI/CD Pipeline

on:
    push:
        branches: ["main"]
        tags: ["v*"]
    pull_request:
        branches: ["main"]

permissions:
    contents: write

jobs:
    build-and-test:
        name: Build and Test (Windows)
        runs-on: windows-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch full history in case version information retrieval requires it

            - name: Cache PowerShell Modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~\Documents\PowerShell\Modules
                      C:\Program Files\PowerShell\Modules
                  key: ${{ runner.os }}-psmodules-${{ hashFiles('**/Install-BuildDependencies.ps1') }}
                  restore-keys: |
                      ${{ runner.os }}-psmodules-

            - name: Install Pester (Test Dependency)
              shell: powershell
              run: |
                  Write-Host "Installing Pester module..."
                  Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
                  Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser

            - name: Cache Build Dependencies
              uses: actions/cache@v4
              with:
                  path: |
                      ~\.local\share\powershell\Modules\ps2exe
                  key: ${{ runner.os }}-buildtools-${{ hashFiles('build-tools/Install-BuildDependencies.ps1') }}
                  restore-keys: |
                      ${{ runner.os }}-buildtools-

            - name: Install Build Dependencies (ps2exe)
              shell: powershell
              run: |
                  # Use the dependency installation script within the project
                  .\build-tools\Install-BuildDependencies.ps1 -Force -Verbose

            - name: Run Tests
              shell: powershell
              env:
                  CI: true
              run: |
                  $ErrorActionPreference = "Stop"
                  
                  # Pester configuration
                  $config = [PesterConfiguration]::Default
                  $config.Run.Path = ".\test\pester"
                  $config.Filter.ExcludeTag = @("Integration", "Local")
                  $config.Run.Exit = $false
                  $config.Run.PassThru = $true
                  $config.CodeCoverage.Enabled = $false
                  $config.TestResult.Enabled = $true
                  $config.TestResult.OutputFormat = "NUnitXml"
                  $config.TestResult.OutputPath = "test-results.xml"
                  
                  # Test execution
                  try {
                      $result = Invoke-Pester -Configuration $config
                      
                      # Check results
                      if ($result.FailedCount -gt 0) {
                          throw "Tests failed: $($result.FailedCount) test(s) failed"
                      }
                      
                      Write-Host "All tests passed successfully!"
                  } catch {
                      Write-Error "Test execution failed: $_"
                      exit 1
                  }

            - name: Publish Test Results
              uses: EnricoMi/publish-unit-test-result-action/composite@v2
              if: always()
              with:
                  files: test-results.xml
                  check_name: "Test Results"
                  comment_title: "Test Results"

            - name: Build Application (Development Mode)
              shell: powershell
              run: |
                  $ErrorActionPreference = "Stop"
                  Write-Host "Building application in Development mode..."
                  .\build-tools\Release-Manager.ps1 -Development -Verbose
                  
                  # Verify build artifacts
                  if (-not (Test-Path ".\release\Focus-Game-Deck.exe")) {
                      throw "Build failed: Focus-Game-Deck.exe not found"
                  }
                  Write-Host "Build completed successfully"

            - name: Smoke Test - Bundled Executables
              shell: powershell
              run: |
                  # Smoke test with explicit exit code checking
                  $ErrorActionPreference = "Stop"

                  Write-Host "Testing Focus-Game-Deck.exe command-line arguments..."

                  # Test --help (should exit with 0)
                  & ".\release\Focus-Game-Deck.exe" --help
                  if ($LASTEXITCODE -ne 0) {
                      throw "Help command failed with exit code: $LASTEXITCODE"
                  }
                  Write-Host "[OK] --help command succeeded"

                  # Test --version (should exit with 0)
                  & ".\release\Focus-Game-Deck.exe" --version
                  if ($LASTEXITCODE -ne 0) {
                      throw "Version command failed with exit code: $LASTEXITCODE"
                  }
                  Write-Host "[OK] --version command succeeded"

                  # Test --list (should exit with 0 if games configured, 1 if not)
                  & ".\release\Focus-Game-Deck.exe" --list
                  $listExitCode = $LASTEXITCODE
                  if ($listExitCode -eq 0) {
                      Write-Host "[OK] --list command succeeded (games configured)"
                  } elseif ($listExitCode -eq 1) {
                      Write-Host "[INFO] --list command reported no games configured (expected in CI)"
                  } else {
                      throw "List command failed with unexpected exit code: $listExitCode"
                  }

                  Write-Host ""
                  Write-Host "All smoke tests passed successfully!"

                  # Exit with success code (overrides $LASTEXITCODE from --list command)
                  exit 0

            - name: Archive Release Artifacts
              shell: powershell
              run: |
                  $source = "release\*"
                  $destination = "FocusGameDeck-Unsigned.zip"
                  Write-Host "Compressing artifacts from $source to $destination"
                  Compress-Archive -Path $source -DestinationPath $destination -Force

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: FocusGameDeck-Unsigned
                  path: FocusGameDeck-Unsigned.zip
                  retention-days: 7

            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/v')
              uses: softprops/action-gh-release@v1
              with:
                  files: FocusGameDeck-Unsigned.zip
                  generate_release_notes: true
                  draft: false
                  prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}

# Future Enhancement: Parallel Job Execution
# To further improve CI/CD performance, consider splitting into parallel jobs:
#
# jobs:
#     test:
#         name: Run Tests
#         runs-on: windows-latest
#         steps:
#             - name: Checkout Repository
#               uses: actions/checkout@v4
#             - name: Install Pester
#               # ... test execution steps
#
#     lint:
#         name: Code Quality Check
#         runs-on: windows-latest
#         steps:
#             - name: Checkout Repository
#               uses: actions/checkout@v4
#             - name: Run PSScriptAnalyzer
#               # ... linter steps
#
#     build:
#         name: Build Application
#         needs: [test, lint]
#         runs-on: windows-latest
#         steps:
#             # ... build steps
#
# This would enable:
# - Parallel test and lint execution
# - Faster feedback on code quality issues
# - Build only after all checks pass
