name: CI/CD Pipeline

on:
    push:
        branches: ["main"]
        tags: ["v*"]
    pull_request:
        branches: ["main"]

permissions:
    contents: write

jobs:
    build-and-test:
        name: Build and Test (Windows)
        runs-on: windows-latest

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch full history in case version information retrieval requires it

            - name: Install Pester (Test Dependency)
              shell: powershell
              run: |
                  Write-Host "Installing Pester module..."
                  Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
                  Install-Module -Name Pester -Force -SkipPublisherCheck -Scope CurrentUser

            - name: Install Build Dependencies (ps2exe)
              shell: powershell
              run: |
                  # Use the dependency installation script within the project
                  .\build-tools\Install-BuildDependencies.ps1 -Force -Verbose

            - name: Run Tests
              shell: powershell
              env:
                  CI: true
              run: |
                  # Exit immediately if an error occurs

                  $ErrorActionPreference = "Stop"
                  # Exclude Integration and Local tests in CI environment
                  # Integration: requires external services
                  # Local: requires desktop environment (e.g., GUI tests)
                  .\test\runners\Invoke-PesterTests.ps1 -ExcludeTag "Integration", "Local"

            - name: Build Application (Development Mode)
              shell: powershell
              run: |
                  # Execute build in Development mode without cloud signing

                  .\build-tools\Release-Manager.ps1 -Development -Verbose

            - name: Smoke Test - Bundled Executables
              shell: powershell
              run: |
                  # Smoke test with explicit exit code checking
                  $ErrorActionPreference = "Stop"

                  Write-Host "Testing Focus-Game-Deck.exe command-line arguments..."

                  # Test --help (should exit with 0)
                  & ".\release\Focus-Game-Deck.exe" --help
                  if ($LASTEXITCODE -ne 0) {
                      throw "Help command failed with exit code: $LASTEXITCODE"
                  }
                  Write-Host "[OK] --help command succeeded"

                  # Test --version (should exit with 0)
                  & ".\release\Focus-Game-Deck.exe" --version
                  if ($LASTEXITCODE -ne 0) {
                      throw "Version command failed with exit code: $LASTEXITCODE"
                  }
                  Write-Host "[OK] --version command succeeded"

                  # Test --list (should exit with 0 if games configured, 1 if not)
                  & ".\release\Focus-Game-Deck.exe" --list
                  $listExitCode = $LASTEXITCODE
                  if ($listExitCode -eq 0) {
                      Write-Host "[OK] --list command succeeded (games configured)"
                  } elseif ($listExitCode -eq 1) {
                      Write-Host "[INFO] --list command reported no games configured (expected in CI)"
                  } else {
                      throw "List command failed with unexpected exit code: $listExitCode"
                  }

                  Write-Host ""
                  Write-Host "All smoke tests passed successfully!"

                  # Exit with success code (overrides $LASTEXITCODE from --list command)
                  exit 0

            - name: Archive Release Artifacts
              shell: powershell
              run: |
                  $source = "release\*"
                  $destination = "FocusGameDeck-Unsigned.zip"
                  Write-Host "Compressing artifacts from $source to $destination"
                  Compress-Archive -Path $source -DestinationPath $destination -Force

            - name: Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: FocusGameDeck-Unsigned
                  path: FocusGameDeck-Unsigned.zip
                  retention-days: 7

            - name: Create GitHub Release
              if: startsWith(github.ref, 'refs/tags/v')
              uses: softprops/action-gh-release@v1
              with:
                  files: FocusGameDeck-Unsigned.zip
                  generate_release_notes: true
                  draft: false
                  prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
